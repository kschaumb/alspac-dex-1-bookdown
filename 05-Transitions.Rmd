

## Transitions in Exercise Groups Over Time
```{r}
load('models/transition_models')
load('data/transition_data.RData')
```



Below, we examine shifts in exercise for weight loss and driven exercise
over time:

\@ref(fig:freq_table1) shows exercise status at ages 14-24 years in girls and
boys, as a percentage of the total number of boys and girls who reported exercise data at the timepoint.

```{r freq_table 1, fig.caption = 'Frequency of Exercise Groups Across Age'}
exercise_group_data <- frq_table_by_age_sex(demo_ed.lf, exercise_group)

exercise_status_plot_1 <- ggplot(data = exercise_group_data, 
    aes(x = sex, y = pct, fill = exercise_group, label = sprintf('%0.1f%%', pct*100))) + #set the aesthetic features, including the labels at one decimal place
    geom_bar(position = position_stack(reverse = TRUE), stat = 'identity') + #add column graph, with male and female separated
    scale_y_continuous(labels = scales::percent, limits = c(0,1))+ #set the lower and upper limits of the y axis ( 0-100 percent); 
    theme(legend.title = element_blank(), axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1), text = element_text(size = 15))+ #make legend text a bit bigger
    labs(x = element_blank(), y = 'Percent (within gender)', title = 'Exercise Groups Across Age') +
    facet_wrap(~age) + 
    theme_classic()+
    theme(legend.title = element_blank(), axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1), text = element_text(size = 15)) + #make legend text a bit bigger 
   scale_fill_manual(values = wes_palette(name = 'GrandBudapest1', n = 3 ))
exercise_status_plot_1
```

Overall, it appears that percentage of males and female in the three
exercise groups is relatively stable from ages 14-18 years, with a possible
increase in exercise for weight loss at age 18 among girls, and a more
substantive increase in exercise for weight loss among men at age 24 and
an increase in driven exercise across gender at age 24.

In the next two graphs, we examine transitions over time amongst the
subset of girls (N = 1169) and boys (N = 568) who completed all
assessments, ages 14-24. Transition plot code derived from
@cernatVisualizingTransitionsTime2021.

```{r}
ex_status_girl_plot <- transition_plot(demo_ed_girls, 'exercise_group.', 'Exercise Status Across Age in Girls', na.rm = TRUE)
ex_status_girl_plot  + 
    theme(legend.text = element_text(size = 12),
          legend.title = element_blank())
```

```{r}
ex_status_boy_plot <- transition_plot(demo_ed_boys, 'exercise_group.', 'Exercise Status Across Age in Boys', na.rm = TRUE)
ex_status_boy_plot  + 
    theme(legend.text = element_text(size = 12),
          legend.title = element_blank())
```

A multi-state model to panel data relies on a Markov assumption, that future evelolution only depends on the current state. 

The likelihood for this basic model, used in msm, is calculated from the transition probability matrix $P(u; t + u)$. The $(r, s)$ entry of $P(u; t + u)$, $prs(u; t + u)$, is the
probability of being in state s at a time t + u, given the state at time u is r.

Sampling times are ignorable if they are fixed in advance, or otherwise chosen independently of the outcome of the process

The subject id variable does not need to be numeric, but observations from the same subject must be adjacent in the dataset, and observations must be ordered by time within subjects

Below is the state table for exercise group, indicating transitions between each state. Transitions from 'no exercise for weight loss' to 'driven exercise' appear to be the least common of all transitions, wtih 164 instances of this transition. 

### Girls

```{r}

#state table for girls
statetable.msm(exercise_group, id, data = transition_data_girls)

#identify possible transitions - in our model, it is assumed that individuals do not need to 'pass through' exercise for weight loss when transitioning in and out of driven exercise, thus; all possible transitions are allowed

plot_2_girls <- plot.prevalence.msm(ex_group_girls_2, mintime = 14, maxtime = 24, xlab = 'age', legend.pos = c(19, 90))
plot_1_girls <- plot.prevalence.msm(ex_group_girls_1, mintime = 14, maxtime = 24, xlab = 'age', legend.pos = c(19, 90))

#Markov model with covariates
hr_1_girls <- hazard.msm(ex_group_girls_covs_1)
ex_group_girls_1_pmat <- pmatrix.msm(ex_group_girls_1, t = 1, ci = 'normal')
ex_group_girls_1_covs_pmat <- pmatrix.msm(ex_group_girls_covs_1, t = 1, ci = 'normal')

ti_girls_hazard <- hr_1_girls[[1]]  
bd_girls_hazard <- hr_1_girls[[2]] 
fear_wt_girls_hazard <- hr_1_girls[[3]] 
bmi_z_girls_hazard <- hr_1_girls[[4]]
ses_girls_hazard <- hr_1_girls[[5]]

```

```{r, label = 'Girls Hazard Ratios'}

dfnames <- c('ti_girls_hazard', 'bd_girls_hazard', 'fear_wt_girls_hazard', 'bmi_z_girls_hazard', 'ses_girls_hazard')
Girl_HRs <- do.call(rbind, lapply(dfnames, function(x) cbind(get(x), Covariate=x))) |> 
  as.data.frame() |> 
  rownames_to_column(var = 'transition') %>% 
 mutate(HR = sprintf("%.3f", as.numeric(HR))) %>% 
 mutate(L = sprintf("%.3f", as.numeric(L))) %>% 
 mutate(U = sprintf("%.3f", as.numeric(U)))

Girl_HRs$transition <- gsub('\\No.', 'No ', Girl_HRs$transition)
Girl_HRs$transition <- gsub('\\...', ' to ', Girl_HRs$transition)
Girl_HRs$transition <- gsub('\\..*', '', Girl_HRs$transition)
Girl_HRs$CI <- paste(Girl_HRs$L, Girl_HRs$U, sep = ', ')
addparens <- function(x){paste('(',x,')')}
Girl_HRs$CI <- addparens(Girl_HRs$CI)
Girl_HRs$HR <- paste(Girl_HRs$HR, Girl_HRs$CI, sep = ' ')


Girl_HRs <- Girl_HRs |> 
  select( - c( L, U, CI)) %>% 
  pivot_wider(names_from = c(transition), values_from = HR)
Girl_HRs['Covariate'][Girl_HRs['Covariate'] == 'ti_girls_hazard'] <- 'Thin-Ideal Internalization [14]'
Girl_HRs['Covariate'][Girl_HRs['Covariate'] == 'bd_girls_hazard'] <- 'Body Satisfaction [14]'
Girl_HRs['Covariate'][Girl_HRs['Covariate'] == 'fear_wt_girls_hazard'] <- 'Fear of Weight Gain [14]'
Girl_HRs['Covariate'][Girl_HRs['Covariate'] == 'bmi_z_girls_hazard'] <- 'BMI Z-score [13]'
Girl_HRs['Covariate'][Girl_HRs['Covariate'] == 'ses_girls_hazard'] <- 'Parent Occupation'

Girl_HRs %>% 
  kbl(caption = 'Hazard Ratios for Transitions with Baseline Covariates - Girls', format = 'html')  %>% 
  kable_paper(full_width = T)   %>% 
  column_spec(2, color = case_when(Girl_HRs$Covariate %in% c('Body Satisfaction [14]', 'Fear of Weight Gain [14]', 'BMI Z-score [13]') ~ 'blue', 
                                    TRUE ~'black')) %>% 
  column_spec(3, color = case_when(Girl_HRs$Covariate %in% c('Body Satisfaction [14]') ~ 'blue', 
                                   Girl_HRs$Covariate %in% c('Parent Occupation') ~ 'red',
                                    TRUE ~'black'))

  



```

```{r}
hr_2_girls <- hazard.msm(ex_group_girls_covs_2)
ti_girls_hazard_2 <-hr_2_girls[[1]]
bmi_girls_hazard_2<- hr_2_girls[[2]] 
fear_wt_girls_hazard_2 <- hr_2_girls[[3]] 
bd_girls_hazard <-hr_2_girls[[4]]
ses_girls_hazard <- hr_2_girls[[5]] 


dfnames <- c('fear_wt_girls_hazard_2', 'bmi_girls_hazard_2', 'ti_girls_hazard_2', 'bd_girls_hazard', 'ses_girls_hazard')
girl_HRs_2 <- do.call(rbind, lapply(dfnames, function(x) cbind(get(x), Covariate=x))) |> 
  as.data.frame() |> 
  rownames_to_column(var = 'transition') %>% 
 mutate(HR = sprintf("%.2f", as.numeric(HR))) %>% 
 mutate(L = sprintf("%.2f", as.numeric(L))) %>% 
 mutate(U = sprintf("%.2f", as.numeric(U)))

girl_HRs_2$transition <- gsub('\\No.', 'No ', girl_HRs_2$transition)
girl_HRs_2$transition <- gsub('\\...', ' to ', girl_HRs_2$transition)
girl_HRs_2$transition <- gsub('\\..*', '', girl_HRs_2$transition)
girl_HRs_2$CI <- paste(girl_HRs_2$L, girl_HRs_2$U, sep = ', ')
addparens <- function(x){paste('(',x,')')}
girl_HRs_2$CI <- addparens(girl_HRs_2$CI)
girl_HRs_2$HR <- paste(girl_HRs_2$HR, girl_HRs_2$CI, sep = ' ')


girl_HRs_2 <- girl_HRs_2 |> 
  select( - c( L, U, CI)) %>% 
  pivot_wider(names_from = c(transition), values_from = HR)
girl_HRs_2['Covariate'][girl_HRs_2['Covariate'] == 'ti_girls_hazard_2'] <- 'Thin Ideal Internalization [14]'
girl_HRs_2['Covariate'][girl_HRs_2['Covariate'] == 'fear_wt_girls_hazard_2'] <- 'Fear of Weight Gain [14]'
girl_HRs_2['Covariate'][girl_HRs_2['Covariate'] == 'bmi_girls_hazard_2'] <- 'BMI Z-score [13]'
girl_HRs_2['Covariate'][girl_HRs_2['Covariate'] == 'bd_girls_hazard'] <- 'Body Satisfaction [14]'
girl_HRs_2['Covariate'][girl_HRs_2['Covariate'] == 'ses_girls_hazard'] <- 'Parent Occupation'

girl_HRs_2 %>% 
  kbl(caption = 'Hazard Ratios for Transitions with Baseline Covariates and Constrained Transitions - girls')  %>% 
  kable_paper(full_width = T) %>% 
  kable_styling(font_size = 13)
```

### Boys


```{r}
#state table for boys

statetable.msm(exercise_group, id, data = transition_data_boys)
plot.prevalence.msm(ex_group_boys_1, mintime = 14, maxtime = 24, xlab = 'age', legend.pos = c(19, 90))
plot.prevalence.msm(ex_group_boys_2, mintime = 14, maxtime = 24, xlab = 'age', legend.pos = c(19, 90))
hr_1_boys <- hazard.msm(ex_group_boys_covs)

ex_group_boys_1_pmat <- pmatrix.msm(ex_group_boys_1, t = 1, ci = 'normal')
ex_group_boys_2_pmat <- pmatrix.msm(ex_group_boys_2, t = 1, ci = 'normal')
ex_group_boys_covs_pmat <- pmatrix.msm(ex_group_boys_covs, t = 1, ci = 'normal')
ti_boys_hazard <-hr_1_boys[[1]]
bmi_boys_hazard <- hr_1_boys[[2]] 
fear_wt_boys_hazard <- hr_1_boys[[3]] 
```

```{r, label = 'Boys Hazard Ratios'}

dfnames <- c('fear_wt_boys_hazard', 'bmi_boys_hazard', 'ti_boys_hazard')
Boy_HRs <- do.call(rbind, lapply(dfnames, function(x) cbind(get(x), Covariate=x))) |> 
  as.data.frame() |> 
  rownames_to_column(var = 'transition') %>% 
 mutate(HR = sprintf("%.2f", as.numeric(HR))) %>% 
 mutate(L = sprintf("%.2f", as.numeric(L))) %>% 
 mutate(U = sprintf("%.2f", as.numeric(U)))

Boy_HRs$transition <- gsub('\\No.', 'No ', Boy_HRs$transition)
Boy_HRs$transition <- gsub('\\...', ' to ', Boy_HRs$transition)
Boy_HRs$transition <- gsub('\\..*', '', Boy_HRs$transition)
Boy_HRs$CI <- paste(Boy_HRs$L, Boy_HRs$U, sep = ', ')
addparens <- function(x){paste('(',x,')')}
Boy_HRs$CI <- addparens(Boy_HRs$CI)
Boy_HRs$HR <- paste(Boy_HRs$HR, Boy_HRs$CI, sep = ' ')


Boy_HRs <- Boy_HRs |> 
  select( - c( L, U, CI)) %>% 
  pivot_wider(names_from = c(transition), values_from = HR)
Boy_HRs['Covariate'][Boy_HRs['Covariate'] == 'ti_boys_hazard'] <- 'Thin Ideal Internalization [14]'
Boy_HRs['Covariate'][Boy_HRs['Covariate'] == 'fear_wt_boys_hazard'] <- 'Fear of Weight Gain [14]'
Boy_HRs['Covariate'][Boy_HRs['Covariate'] == 'bmi_boys_hazard'] <- 'BMI Z-score [13]'


Boy_HRs %>% 
  kbl(caption = 'Hazard Ratios for Transitions with Baseline Covariates - Boys', format = 'html')  %>% 
  kable_paper(full_width = T) 

```

column_spec(2, color = case_when(Girl_HRs$Covariate %in% c('Body Satisfaction [14]', 'Fear of Weight Gain [14]', 'BMI Z-score [13]') ~ 'blue', 
                                    TRUE ~'black')) %>% 

```{r}
hr_2_boys <- hazard.msm(ex_group_boys_covs_2)
ti_boys_hazard_2 <-hr_2_boys[[1]]
bmi_boys_hazard_2<- hr_2_boys[[2]] 
fear_wt_boys_hazard_2 <- hr_2_boys[[3]] 
bd_boys_hazard <-hr_2_boys[[4]]
ses_boys_hazard <- hr_2_boys[[5]] 


dfnames <- c('fear_wt_boys_hazard_2', 'bmi_boys_hazard_2', 'ti_boys_hazard_2', 'bd_boys_hazard', 'ses_boys_hazard')
Boy_HRs_2 <- do.call(rbind, lapply(dfnames, function(x) cbind(get(x), Covariate=x))) |> 
  as.data.frame() |> 
  rownames_to_column(var = 'transition') %>% 
 mutate(HR = sprintf("%.2f", as.numeric(HR))) %>% 
 mutate(L = sprintf("%.2f", as.numeric(L))) %>% 
 mutate(U = sprintf("%.2f", as.numeric(U)))

Boy_HRs_2$transition <- gsub('\\No.', 'No ', Boy_HRs_2$transition)
Boy_HRs_2$transition <- gsub('\\...', ' to ', Boy_HRs_2$transition)
Boy_HRs_2$transition <- gsub('\\..*', '', Boy_HRs_2$transition)
Boy_HRs_2$CI <- paste(Boy_HRs_2$L, Boy_HRs_2$U, sep = ', ')
addparens <- function(x){paste('(',x,')')}
Boy_HRs_2$CI <- addparens(Boy_HRs_2$CI)
Boy_HRs_2$HR <- paste(Boy_HRs_2$HR, Boy_HRs_2$CI, sep = ' ')


Boy_HRs_2 <- Boy_HRs_2 |> 
  select( - c( L, U, CI)) %>% 
  pivot_wider(names_from = c(transition), values_from = HR)
Boy_HRs_2['Covariate'][Boy_HRs_2['Covariate'] == 'ti_boys_hazard_2'] <- 'Thin Ideal Internalization [14]'
Boy_HRs_2['Covariate'][Boy_HRs_2['Covariate'] == 'fear_wt_boys_hazard_2'] <- 'Fear of Weight Gain [14]'
Boy_HRs_2['Covariate'][Boy_HRs_2['Covariate'] == 'bmi_boys_hazard_2'] <- 'BMI Z-score [13]'
Boy_HRs_2['Covariate'][Boy_HRs_2['Covariate'] == 'bd_boys_hazard'] <- 'Body Satisfaction [14]'
Boy_HRs_2['Covariate'][Boy_HRs_2['Covariate'] == 'ses_boys_hazard'] <- 'Parent Occupation'

Boy_HRs_2 %>% 
  kbl(caption = 'Hazard Ratios for Transitions with Baseline Covariates and Constrained Transitions - Boys')  %>% 
  kable_paper(full_width = T) %>% 
  kable_styling(font_size = 13) %>% 
  column_spec(2, color = case_when(Boy_HRs_2$Covariate %in% c('BMI Z-score [13]') ~ 'blue', 
                              TRUE ~'black')) %>% 
  column_spec(3, color = case_when(Boy_HRs_2$Covariate %in% c('BMI Z-score [13]') ~ 'blue', 
                              TRUE ~'black')) %>% 
  column_spec(4, color = case_when(Boy_HRs_2$Covariate %in% c('BMI Z-score [13]') ~ 'red', 
                              TRUE ~'black')) %>% 
  column_spec(5, color = case_when(Boy_HRs_2$Covariate %in% c('BMI Z-score [13]') ~ 'blue', 
                              TRUE ~'black')) %>% 
  column_spec(7, color = case_when(Boy_HRs_2$Covariate %in% c('BMI Z-score [13]') ~ 'blue', 
                              TRUE ~'black'))

```

